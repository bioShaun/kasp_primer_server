# KASP Primer Design Service - ä¼˜åŒ–æ–¹æ¡ˆ v2

## 1. æ ¸å¿ƒç›®æ ‡
åŸºäº `SNP_Primer_Pipeline3` æ„å»º KASP å¼•ç‰©è®¾è®¡ Web æœåŠ¡ã€‚
-   **è¾“å…¥**: SNP åæ ‡æ ¼å¼ (Pipeline åŸç”Ÿæ”¯æŒ)
-   **è¾“å‡º**: ç»“æœè¡¨æ ¼ + æ–‡ä»¶ä¸‹è½½

---

## 2. æ¶æ„è®¾è®¡

### 2.1 æŠ€æœ¯é€‰å‹
| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| å‰ç«¯ | Vue 3 + Vite + Element Plus | å“åº”å¼ UI |
| åç«¯ | **FastAPI** + Uvicorn | REST APIï¼Œè‡ªåŠ¨æ–‡æ¡£ï¼ŒåŸç”Ÿå¼‚æ­¥ |
| å®¹å™¨ | Docker + docker-compose | ä¸€é”®éƒ¨ç½² |
| è¿è¡Œæ—¶ | SNP_Primer_Pipeline3 + BLAST+ | æ ¸å¿ƒè®¡ç®— |

### 2.2 ç»„ä»¶å›¾
```mermaid
graph LR
    subgraph Docker Container
        Vue[Vue Frontend]
        FastAPI[FastAPI]
        Pipeline[snp-primer CLI]
        RefDB[(Reference DB)]
    end
    User --> Vue --> FastAPI --> Pipeline --> RefDB
```

### 2.3 å…³é”®ä¼˜åŒ–ç‚¹

#### â‘  å¼‚æ­¥ä»»åŠ¡å¤„ç†
-   **é—®é¢˜**: å¤§æ‰¹é‡ SNP è®¾è®¡å¯èƒ½è€—æ—¶è¾ƒé•¿ (>30s)ï¼ŒåŒæ­¥è¯·æ±‚ä¼šé˜»å¡ã€‚
-   **æ–¹æ¡ˆ**: 
    -   **MVP (v1.0)**: åŒæ­¥å¤„ç†ï¼Œå‰ç«¯æ˜¾ç¤º Loadingã€‚é™åˆ¶å•æ¬¡æœ€å¤§ SNP æ•°é‡ (å¦‚ 50)ã€‚
    -   **v1.1**: å¼•å…¥ Celery + Redisï¼Œåå°å¼‚æ­¥æ‰§è¡Œï¼Œè½®è¯¢çŠ¶æ€ã€‚
-   **ä»»åŠ¡åˆ—è¡¨æ›´æ–°**: æ— éœ€ç«‹å³å®ç° Celeryï¼Œä½†è®¾è®¡ API æ—¶é¢„ç•™ `job_id` å­—æ®µã€‚

#### â‘¡ å¤šå‚è€ƒåŸºå› ç»„æ”¯æŒ
-   **é—®é¢˜**: ç”¨æˆ·å¯èƒ½éœ€è¦åˆ‡æ¢ä¸åŒç‰©ç§/ç‰ˆæœ¬çš„å‚è€ƒåŸºå› ç»„ã€‚
-   **æ–¹æ¡ˆ**: 
    -   åç«¯é…ç½®æ–‡ä»¶ `genomes.yaml` å®šä¹‰å¯ç”¨åŸºå› ç»„åˆ—è¡¨ã€‚
    -   å‰ç«¯ä¸‹æ‹‰é€‰æ‹©ã€‚
    -   Docker æŒ‚è½½åŸºå› ç»„ç›®å½•ã€‚

#### â‘¢ é”™è¯¯å¤„ç†ä¸æ—¥å¿—
-   **é—®é¢˜**: æµæ°´çº¿æ‰§è¡Œå¤±è´¥æ—¶ç”¨æˆ·æ— æ³•æ’æŸ¥ã€‚
-   **æ–¹æ¡ˆ**: 
    -   æ•è· `stderr` å¹¶è¿”å›ç»™å‰ç«¯ã€‚
    -   æ¯æ¬¡ä»»åŠ¡ç”Ÿæˆå”¯ä¸€ `job_id`ï¼Œæ—¥å¿—æŒä¹…åŒ–ã€‚

#### â‘£ ç»“æœæ–‡ä»¶ç®¡ç†
-   **é—®é¢˜**: ç»“æœæ–‡ä»¶éœ€è¦æ¸…ç†ï¼Œé¿å…ç£ç›˜å æ»¡ã€‚
-   **æ–¹æ¡ˆ**: 
    -   ä½¿ç”¨ä¸´æ—¶ç›®å½• + å®šæ—¶æ¸…ç† (å¦‚ cron æˆ– APScheduler)ã€‚
    -   æˆ–åŸºäº `job_id` è®¾ç½®è¿‡æœŸæ—¶é—´ (å¦‚ 24h)ã€‚

---

## 3. API è®¾è®¡ (ä¼˜åŒ–ç‰ˆ)

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è¯·æ±‚/å“åº” |
|------|------|------|-----------|
| `/api/genomes` | GET | è·å–å¯ç”¨åŸºå› ç»„åˆ—è¡¨ | `["wheat_v1", "rice_v2"]` |
| `/api/design` | POST | æäº¤è®¾è®¡ä»»åŠ¡ | `{snps, genome, options}` â†’ `{job_id, status}` |
| `/api/job/<id>` | GET | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€/ç»“æœ | `{status, results?, error?}` |
| `/api/download/<id>/<file>` | GET | ä¸‹è½½ç»“æœæ–‡ä»¶ | Binary |

---

## 4. UI è®¾è®¡ (ç§‘ç ”é£æ ¼)

### 4.1 è®¾è®¡åŸåˆ™
-   **ç®€æ´ä¸“ä¸š**: æ— å¤šä½™è£…é¥°ï¼Œçªå‡ºåŠŸèƒ½
-   **é«˜ä¿¡æ¯å¯†åº¦**: è¡¨æ ¼ä¸ºä¸»ï¼Œæ•°æ®ä¸€ç›®äº†ç„¶
-   **ä½è§†è§‰å¹²æ‰°**: ä¸­æ€§è‰²è°ƒï¼Œé¿å…é²œè‰³é…è‰²

### 4.2 é…è‰²æ–¹æ¡ˆ
```
ä¸»è‰²è°ƒ:  #2C3E50 (æ·±è“ç° - æ ‡é¢˜/æŒ‰é’®)
èƒŒæ™¯è‰²:  #F8F9FA (æµ…ç°ç™½)
è¾¹æ¡†è‰²:  #DEE2E6 (ç°è‰²)
å¼ºè°ƒè‰²:  #3498DB (è“è‰² - é“¾æ¥/æŒ‰é’®æ‚¬åœ)
æˆåŠŸè‰²:  #27AE60 (ç»¿è‰² - å®ŒæˆçŠ¶æ€)
é”™è¯¯è‰²:  #E74C3C (çº¢è‰² - é”™è¯¯æç¤º)
```

### 4.3 å­—ä½“
-   **ä¸­æ–‡**: æ€æºé»‘ä½“ / ç³»ç»Ÿé»˜è®¤
-   **è‹±æ–‡/ä»£ç **: `Roboto Mono` / `monospace`
-   **æ­£æ–‡**: 14px, è¡Œé«˜ 1.6

### 4.4 å¸ƒå±€çº¿æ¡†
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§¬ KASP Primer Design                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  å‚è€ƒåŸºå› ç»„                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Wheat v1.0 (IWGSC RefSeq v1.0)  â–¼ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                             â”‚
â”‚  SNP åæ ‡ (Chr Pos Ref Alt)  [ğŸ“‹ åŠ è½½ç¤ºä¾‹] â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ chr7A  7659  T  C                  â”‚     â”‚
â”‚  â”‚ chr7A  7716  A  G                  â”‚     â”‚
â”‚  â”‚                                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                             â”‚
â”‚  [  å¼€å§‹è®¾è®¡  ]                             â”‚
â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è®¾è®¡ç»“æœ                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ SNP ID    â”‚ Allele X â”‚ Allele Y â”‚ Common â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚ chr7A-... â”‚ ATCG...  â”‚ ATCG...  â”‚ ATCG.. â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                             â”‚
â”‚  ğŸ“¥ ä¸‹è½½æ‘˜è¦    ğŸ“¥ ä¸‹è½½å®Œæ•´ç»“æœ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 äº¤äº’åŠŸèƒ½
| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **åŠ è½½ç¤ºä¾‹** | ç‚¹å‡»åè‡ªåŠ¨å¡«å……æµ‹è¯• SNP æ•°æ®å¹¶é€‰æ‹© `test_reference` åŸºå› ç»„ |
| **å¼€å§‹è®¾è®¡** | æäº¤åæ˜¾ç¤º Loadingï¼Œå®Œæˆåå±•ç¤ºç»“æœè¡¨æ ¼ |
| **ä¸‹è½½** | æ”¯æŒä¸‹è½½ `all_KASP_primers_summary.txt` å’Œ `all_KASP_primers.txt` |

### 4.6 ç»„ä»¶è§„èŒƒ
| ç»„ä»¶ | æ ·å¼ |
|------|------|
| æŒ‰é’® | åœ†è§’ 4px, æ— é˜´å½±, å®å¿ƒå¡«å…… |
| è¾“å…¥æ¡† | è¾¹æ¡† 1px, å†…è¾¹è· 12px |
| è¡¨æ ¼ | æ–‘é©¬çº¹, å›ºå®šè¡¨å¤´, æ°´å¹³æ»šåŠ¨ |
| é“¾æ¥ | è“è‰² #3498DB, ä¸‹åˆ’çº¿æ‚¬åœ |
| Loading | ç®€å• spinner, æ— åŠ¨ç”»è¿‡æ¸¡ |

---

## 5. Docker éƒ¨ç½²ç­–ç•¥

### 5.1 é•œåƒç»“æ„
```dockerfile
# Stage 1: Build Frontend
FROM node:20-alpine AS frontend
WORKDIR /app
COPY frontend/ .
RUN npm ci && npm run build

# Stage 2: Runtime
FROM python:3.10-slim

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    ncbi-blast+ \
    git \
    && rm -rf /var/lib/apt/lists/*

# ä» GitHub å®‰è£… SNP_Primer_Pipeline3
# å¯æŒ‡å®šç‰ˆæœ¬: git+https://github.com/bioShaun/SNP_Primer_Pipeline3.git@v1.0.0
RUN pip install --no-cache-dir \
    git+https://github.com/bioShaun/SNP_Primer_Pipeline3.git \
    fastapi uvicorn[standard]

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY --from=frontend /app/dist /app/static
COPY backend/ /app
WORKDIR /app

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

> [!TIP]
> å¯é€šè¿‡ `@tag` æˆ– `@commit` é”å®šç‰ˆæœ¬ï¼Œå¦‚:
> `git+https://github.com/bioShaun/SNP_Primer_Pipeline3.git@v1.0.0`

### 5.2 docker-compose.yml
```yaml
services:
  kasp:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - /path/to/genomes:/data/genomes:ro
    environment:
      - GENOME_CONFIG=/app/genomes.yaml
```

---

## 6. ä¼˜åŒ–åçš„ä»»åŠ¡åˆ—è¡¨

### Phase 1: åŸºç¡€æ­å»º
- [ ] åˆå§‹åŒ–é¡¹ç›®ç»“æ„ (backend/, frontend/)
- [ ] åˆ›å»º FastAPI éª¨æ¶ (main.py, config.py)
- [ ] åˆ›å»º Vue 3 é¡¹ç›® (Vite + Element Plus)
- [ ] ç¼–å†™ Dockerfile (å¤šé˜¶æ®µæ„å»º)
- [ ] ç¼–å†™ docker-compose.yml

### Phase 2: åç«¯å®ç°
- [ ] å®ç° `/api/genomes` (è¯»å–é…ç½®)
- [ ] å®ç° `/api/design` (è°ƒç”¨ snp-primer CLI)
- [ ] å®ç° `/api/job/<id>` (MVP: ç›´æ¥è¿”å›ç»“æœ)
- [ ] å®ç° `/api/download/<id>/<file>`
- [ ] æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### Phase 3: å‰ç«¯å®ç°
- [ ] å®ç°è¾“å…¥è¡¨å• (åŸºå› ç»„é€‰æ‹© + SNP è¾“å…¥)
- [ ] å®ç°ç»“æœè¡¨æ ¼ (Element Plus Table)
- [ ] å®ç°ä¸‹è½½æŒ‰é’®
- [ ] æ·»åŠ  Loading çŠ¶æ€å’Œé”™è¯¯æç¤º

### Phase 4: æµ‹è¯•ä¸éªŒè¯
- [ ] æ„å»º Docker é•œåƒ
- [ ] ä½¿ç”¨æµ‹è¯•æ•°æ®éªŒè¯ç«¯åˆ°ç«¯æµç¨‹
- [ ] éªŒè¯ä¸‹è½½åŠŸèƒ½

---

## 7. éªŒè¯è®¡åˆ’

### 7.1 æµ‹è¯•æ•°æ®
æµ‹è¯•æ•°æ®ä½äº `test_data/` ç›®å½•ï¼š

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `snp_pos_example.txt` | ç¤ºä¾‹ SNP åæ ‡è¾“å…¥ |
| `blastdb/test_reference.fa` | æµ‹è¯•ç”¨å‚è€ƒåŸºå› ç»„ (å·²å»ºç«‹ BLAST ç´¢å¼•) |

**ç¤ºä¾‹è¾“å…¥å†…å®¹**:
```
chr7A	7659	T	C
chr7A	7716	A	G
```

### 7.2 å•å…ƒæµ‹è¯•
-   **å‘½ä»¤**: `pytest backend/tests/`
-   **è¦†ç›–**: SNP è¾“å…¥è§£æã€å‘½ä»¤æ„é€ 

### 7.3 é›†æˆæµ‹è¯• (Docker)
```bash
# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æµ‹è¯• API
curl -X POST http://localhost:8000/api/design \
     -H "Content-Type: application/json" \
     -d '{"snps": "chr7A\t7659\tT\tC\nchr7A\t7716\tA\tG", "genome": "test_reference"}'
```

### 7.4 æ‰‹åŠ¨éªŒè¯
1. æ‰“å¼€ `http://localhost:8000`
2. é€‰æ‹©å‚è€ƒåŸºå› ç»„: `test_reference`
3. è¾“å…¥ SNP åæ ‡ (ä» `snp_pos_example.txt` å¤åˆ¶)
4. ç‚¹å‡»"å¼€å§‹è®¾è®¡"
5. éªŒè¯è¡¨æ ¼æ˜¾ç¤ºç»“æœ
6. ç‚¹å‡»ä¸‹è½½ï¼Œç¡®è®¤æ–‡ä»¶å†…å®¹

